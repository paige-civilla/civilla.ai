REPLIT TASK: Fix “pages flash then return to Your Case” caused by 401s on /api/cases/:caseId/*

Context:
Server logs show repeated 401 Unauthorized for case endpoints right after navigation.
This causes the UI to fall back to “Your Case” (it’s not the menu; it’s auth cookies not being sent/accepted).

GOAL:
When logged in, ALL in-app API calls must carry the session cookie reliably.
Fix BOTH:
1) Frontend fetch always includes credentials
2) Backend CORS + session cookie settings allow browser to send/receive that cookie

STEP 1 — FRONTEND: Force credentials: "include" for ALL API calls
Find the shared request helper (commonly one of these):
- client/src/lib/api.ts
- client/src/lib/queryClient.ts
- client/src/lib/apiRequest.ts
- anywhere `fetch("/api/` is wrapped

Do this:
A) If there is a central helper (apiRequest), set:
   fetch(url, { ...options, credentials: "include" })

B) Also ensure React Query fetchers use credentials include.
Search and patch:
grep -RIn --exclude-dir=node_modules --exclude-dir=dist 'fetch\\("/api' client/src

Update every direct fetch("/api/...") to include:
  credentials: "include"

STEP 2 — BACKEND: Fix CORS for cookie-based auth (do NOT use "*")
In server/index.ts (or wherever cors() is configured):
- Ensure cors is configured with credentials: true
- origin must be a specific allow-list or a function that echoes the request origin if allowed

Implement:
const allowedOrigins = [
  "https://civilla.ai",
  "https://www.civilla.ai",
  // add your Replit public URL(s) if applicable
];

app.use(cors({
  origin: (origin, cb) => {
    if (!origin) return cb(null, true); // allow same-origin / server-to-server
    if (allowedOrigins.includes(origin)) return cb(null, true);
    // also allow *.replit.app (or your current deployed host) if needed:
    if (origin.endsWith(".replit.app")) return cb(null, true);
    if (origin.endsWith(".replit.dev")) return cb(null, true);
    return cb(new Error("CORS blocked: " + origin), false);
  },
  credentials: true,
}));

IMPORTANT:
- Remove any cors config that sets Access-Control-Allow-Origin: "*"
- Cookies will NOT work with wildcard origins.

STEP 3 — BACKEND: Ensure session cookie settings work in production domains
Locate session middleware (express-session / cookie-session).
Set cookie options for production:

If the app is served from a different domain than the API, use:
  sameSite: "none"
  secure: true

If the app and API are same-site (same domain), use:
  sameSite: "lax"
  secure: true in production

Implement logic:
const isProd = process.env.NODE_ENV === "production";
session({
  cookie: {
    httpOnly: true,
    secure: isProd,
    sameSite: isProd ? "lax" : "lax",
    // If you are truly cross-site (frontend domain differs from API domain), change to:
    // sameSite: "none",
  }
})

STEP 4 — VERIFY with a REAL browser test
A) Log into the app.
B) Open DevTools → Network → click a module like Evidence.
C) Confirm the request headers include Cookie.
D) Confirm server logs show 200s (not 401s) for:
   GET /api/cases/:caseId
   GET /api/cases/:caseId/phase-status
   GET /api/cases/:caseId/draft-readiness

STEP 5 — Add a quick diagnostic endpoint (temporary)
Add GET /api/auth/whoami (requireAuth) that returns { userId, email }.
Use it to confirm session works on the deployed host.

STEP 6 — Report back in Replit summary
- Which file you changed for frontend fetch credentials
- Which file you changed for cors/session cookie settings
- Before/after logs: show 401s disappear when clicking menu items