REPLIT TASK: FULL APP AUDIT + FIX PASS (Onboarding, Buttons/Links, AI Pipelines, Routes)

GOAL
Run a complete end-to-end audit of Civilla and produce a report that answers:
1) Onboarding: what is broken, where, and why
2) Buttons/Links: which UI buttons are not working or route incorrectly (including nav + suggested question chips)
3) AI: what is working vs failing (Lexi, OCR extraction, AI analysis, claims autosuggest, pattern analysis, doc compile)
4) Routes: confirm frontend routes match backend endpoints and no regressions
5) Fix the highest-impact breakages and re-run the audit to confirm

IMPORTANT
- Do NOT guess.
- Do NOT say “looks fine” unless verified by clicking or by automated test.
- Provide concrete file names + line numbers for every issue found.
- Produce a final “PASS/FAIL” table for every audit section.

========================================
PART 0 — SAFETY + SETUP
========================================

A) Create a new branch named:
audit/full-app-pass-01

B) Confirm env/secrets exist (do not print secrets):
- DATABASE_URL
- OPENAI_API_KEY
- GOOGLE_CLOUD_VISION_API_KEY (if OCR is enabled)
- STRIPE_SECRET_KEY / STRIPE_WEBHOOK_SECRET (if billing enabled)

If anything missing, note it in the report.

========================================
PART 1 — AUTOMATED BUTTON/LINK AUDIT (FRONTEND)
========================================

1) Add Playwright to the repo (if not present).
Create:
- tests/ui-smoke.spec.ts
- tests/helpers/login.ts (if you can log in via UI)
- tests/helpers/seed.ts (optional)

2) Write Playwright smoke tests that:
A) Load app unauthenticated:
- Verify marketing pages load and main CTA links work (if applicable)

B) Sign up / Log in (use a test user account):
- If signup flow is flaky, use an existing test account in Replit secrets:
  TEST_EMAIL / TEST_PASSWORD
  (If missing, create these secrets and use them.)

C) ONBOARDING FLOW TEST
- Verify onboarding loads
- Click Next through every step
- For each required field:
  - Ensure “I don’t know yet” and “Prefer not to say” buttons are visible (per your spec)
  - Ensure selecting those allows Next to continue
- Verify final submit completes and redirects to the intended page (per current requirement)
  - If the requirement is: after onboarding go to “Start Here”, enforce it and test it.

D) NAV + ROUTE TESTS (LOGGED IN)
Click and verify the page changes (URL + visible heading) for:
- Dashboard
- Start Here
- Timeline
- Evidence
- Exhibits
- Trial Prep
- Patterns
- Documents
- Parenting Plan
- Child Support
- Account Settings
- Lexi open/close toggle
Also verify that the mobile nav dropdown scroll works and does not freeze the page.

E) BUTTON SCAN (HIGH IMPACT)
On each of these pages, click the primary buttons and verify a non-error result:
- Evidence: Upload button opens picker; open viewer; run extraction; run AI analysis; run claims suggest (if gated, verify paywall modal not broken)
- Documents: Open creator; compile from claims; export
- Patterns: Generate; export
- Trial Prep: Add item; pin; export binder
- Lexi: Start conversation; new thread; click suggested chip should send message

3) Output Playwright results:
- Save screenshots/videos on failure
- Summarize failing selectors and routes

========================================
PART 2 — ROUTE + ENDPOINT AUDIT (BACKEND)
========================================

Create a script:
- script/auditRoutes.ts

It should:
- Print a list of all Express routes registered (method + path)
- Highlight required AI/billing routes:
  /api/lexi/*
  /api/ai/health
  /api/vision/health
  /api/cases/:caseId/evidence/:evidenceId/extraction/*
  /api/cases/:caseId/evidence/:evidenceId/ai-analyses/*
  /api/cases/:caseId/evidence/:evidenceId/claims/suggest
  /api/cases/:caseId/documents/compile-claims
  /api/cases/:caseId/pattern-analysis
  /api/cases/:caseId/pattern-analysis/export
  /api/search
  /api/billing/*
  /api/admin/*
  /api/grants/*
- Fail if any expected route is missing

Also create:
- script/apiSmoke.ts

It should:
- Log in (session cookie) OR call endpoints via internal request helper
- Hit health checks:
  GET /api/ai/health (expect ok:true)
  GET /api/vision/health (expect ok true or clear missing key message)
- Create a case (if allowed) and verify it returns 200
- Upload a tiny test image to evidence, then:
  trigger extraction -> verify status progresses
  trigger AI analysis -> verify status progresses
  trigger claim suggest -> verify claims created

If file upload automation is hard, at minimum validate that these endpoints respond with correct gating errors (402/409) instead of 500.

========================================
PART 3 — AI PIPELINE AUDIT (WHAT WORKS / WHAT FAILS)
========================================

Add structured logging checks:
- Ensure errors are not swallowed in:
  Lexi chat route
  evidence extraction jobs
  AI analysis endpoint
  claims autosuggest job
  pattern analysis endpoint
  compile-claims endpoint

For each, confirm:
- The code returns a user-safe error message (no secrets)
- The server logs include the root error
- Any credit refund logic triggers on failure (if using credits)

Create a report section:
AI Feature | Trigger | Expected | Actual | PASS/FAIL | Error | Fix

========================================
PART 4 — FIX PASS (ONLY TOP PRIORITY)
========================================

After the audit identifies failures, fix these FIRST:
1) Onboarding cannot complete / wrong redirect / fields not behaving
2) Navigation links broken or routing wrong
3) Lexi send failing (chips not sending; thread create; auth)
4) Extraction/analysis endpoints returning 500
5) Any button that should navigate but does nothing

For each fix:
- Include file + exact change
- Re-run the Playwright smoke suite
- Re-run apiSmoke.ts

========================================
PART 5 — FINAL OUTPUT (MUST BE DETAILED)
========================================

Produce a single report file:
AUDIT_REPORT_FULL_APP.md

It must contain:

1) ENV STATUS
- Which keys present/missing (true/false only)

2) FRONTEND BUTTONS/LINKS TABLE
- Page | Button/Link | Expected | Actual | PASS/FAIL | Screenshot ref | File/Line

3) ONBOARDING FLOW TABLE
- Step | Action | PASS/FAIL | Error | File/Line

4) AI FEATURES TABLE
- Feature | PASS/FAIL | Evidence | Error | Fix applied

5) ROUTES TABLE
- Expected route list with PASS/FAIL

6) FIXES APPLIED
- Bullet list of fixes with file/line + commit hash

7) FINAL VERDICT
- “Ready for testing tomorrow: YES/NO”
- If NO: list blocking items

========================================
RUN ORDER
========================================

1) npm test (if exists)
2) npx playwright test
3) npx tsx script/auditRoutes.ts
4) npx tsx script/apiSmoke.ts
5) Write AUDIT_REPORT_FULL_APP.md
6) If fixes applied: re-run steps 2–4 and update report

DELIVERABLE
Commit the audit scripts + report + any fixes to the branch and summarize the results clearly.