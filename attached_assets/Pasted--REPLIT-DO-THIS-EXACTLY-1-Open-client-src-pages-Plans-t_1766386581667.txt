/**
 * REPLIT — DO THIS EXACTLY
 * 1) Open: client/src/pages/Plans.tsx
 * 2) Replace the ENTIRE file with the code below
 * 3) Do NOT modify Navbar.tsx, NavbarCream.tsx, or Footer.tsx
 *
 * This implements your pricing spec (Family Law only) + add-ons in the hero,
 * 4-across on desktop, and a clean "Save 17%" (no ~).
 */

import React, { useMemo, useState } from "react";

type BillingMode = "monthly" | "yearly";

type Plan = {
  id: "starter" | "core" | "pro" | "premium";
  name: string;
  purpose: string;
  monthly?: number;
  yearly?: number;
  fixedPriceLabel?: string; // starter
  fixedPriceSub?: string;   // starter
  cta: string;
  included: string[];
  notIncluded?: string[];
  finePrint: string;
};

type AddOn = {
  id: string;
  name: string;
  price: string;
  purpose: string;
  includes: string[];
  footnote?: string;
};

const YEARLY_SAVINGS_PERCENT = 17;

const SHARED_PRINCIPLES: string[] = [
  "civilla is educational and organizational only",
  "civilla is not a law firm and does not provide legal advice",
  "All document tools require affirmative acknowledgment, disclaimers, and release before download",
  "No refunds on subscriptions (with clearly stated, narrow exceptions)",
  "All plans support interstate family law cases",
  "All plans support self-represented (pro se) users",
  "All plans support Idaho and other U.S. jurisdictions (state selected during onboarding)",
];

const PLANS: Plan[] = [
  {
    id: "starter",
    name: "Free Starter (3-Day Trial)",
    purpose:
      "Let users understand what civilla is, how it thinks, and whether it helps — without exposing you to heavy processing costs or misuse.",
    fixedPriceLabel: "$0",
    fixedPriceSub: "for 3 days",
    cta: "Start Free Starter",
    included: [
      "1 family law case (view-only, no additional cases)",
      "Pattern analysis (read-only)",
      "Evidence upload (documents only)",
      "Evidence timeline (read-only)",
      "Case journey overview (read-only)",
      "Lexi research & education (text + talk-to-text only)",
      "Plain-language explanations (pro se vs self-represented, common terms, what filings generally mean)",
      "Create 1 sample document (cannot download; permanent large civilla watermark; cannot be removed)",
      "Kid profiles (basic)",
      "Journaling / notes (not analyzed)",
      "Dark mode & accessibility settings",
    ],
    notIncluded: [
      "No document downloads",
      "No exhibits",
      "No transcription",
      "No video uploads",
      "No audio uploads",
      "No AI deadline extraction",
      "No reminders",
      "No certificates of service",
      "No notices of service",
      "No parenting plan builder",
      "No child support estimator",
      "No exhibits builder",
      "No co-parent communication tools",
      "No additional storage purchases",
    ],
    finePrint: "Free Starter is $0 for 3 days. Educational use only. Not legal advice.",
  },
  {
    id: "core",
    name: "Core",
    purpose: "For one user actively organizing one family law case, with full tools and downloads.",
    monthly: 19.99,
    yearly: 199,
    cta: "Select Core",
    included: [
      "Everything in Free, plus:",
      "1 active family law case",
      "30 GB storage",
      "Unlimited document uploads (reasonable use enforced internally)",
      "Evidence timeline (fully interactive)",
      "Pattern analysis (full)",
      "Lexi research engine (statutes, case law, court rules) with citations + sources shown",
      "AI document analysis",
      "AI deadline extraction (user confirmation required)",
      "Task & deadline tracking",
      "Reminders (email or text — opt-in per type, confirm before activation)",
      "Document creator (responses, counter-petitions, motions: dismiss/compel/enforce/amend/limine, etc.)",
      "Downloadable documents with mandatory disclaimers + acknowledgment",
      "civilla educational footnotes included",
      "Notices of service",
      "Certificates of service",
      "Parenting plan builder",
      "Child support estimator (not calculator)",
      "Exhibit builder (basic)",
      "Audio uploads + transcription",
      "Large document accommodation (e.g., OFW exports)",
      "Kid profiles with evidence linking",
    ],
    notIncluded: [
      "Co-parent communication (CivillaConnect)",
      "Advanced exhibits",
      "Video uploads",
    ],
    finePrint: "No refunds on monthly or yearly subscriptions (limited exceptions apply).",
  },
  {
    id: "pro",
    name: "Pro",
    purpose: "For one user who needs advanced exhibits, deeper workflows, and priority processing.",
    monthly: 29.99,
    yearly: 299,
    cta: "Select Pro",
    included: [
      "Everything in Core, plus:",
      "50 GB storage",
      "Advanced exhibits builder",
      "Video uploads",
      "Dual OCR verification (cross-checked)",
      "Advanced pattern reporting (narrative building; timeline → evidence → claim mapping)",
      "Parenting plan “age-up” scenarios",
      "High-conflict case support tools",
      "Mediation & pre-trial preparation workflows",
      "Hearing and trial prep organization",
      "Draft trial binder structure",
      "Evidence tagging by issue, child, and claim",
      "Enhanced Lexi research depth",
      "Priority processing",
    ],
    finePrint: "Educational and organizational only. Not legal advice.",
  },
  {
    id: "premium",
    name: "Premium",
    purpose: "For one user with complex needs: deeper analytics, discovery tracking, and priority support.",
    monthly: 49.99,
    yearly: 499,
    cta: "Select Premium",
    included: [
      "Everything in Pro, plus:",
      "100 GB storage",
      "Advanced narrative reports (court-ready organization, still educational)",
      "Full exhibits management",
      "Multi-child, multi-issue analytics",
      "Advanced reminders & escalation tracking",
      "Complex discovery tracking",
      "Post-judgment workflows (enforcement, modification)",
      "Appeals awareness (education only)",
      "Priority support",
      "Early access to new features",
    ],
    finePrint: "Educational and organizational only. Not legal advice.",
  },
];

const ADD_ONS: AddOn[] = [
  {
    id: "case-slot",
    name: "Additional Case Slot",
    price: "$9.99/month per additional case",
    purpose: "Designed for multiple co-parents / multiple cases.",
    includes: ["+30 GB storage per case", "Full feature parity with your current plan"],
  },
  {
    id: "evidence-only",
    name: "Evidence-Only Storage (No Analysis)",
    price: "$4.99/month",
    purpose: "Upload and organize evidence without triggering AI processing costs.",
    includes: [
      "Evidence uploads",
      "Journaling",
      "Timeline storage",
      "No analysis until upgraded",
      "Once upgraded, initial backlog analysis is included (no retroactive penalty)",
    ],
  },
  {
    id: "over-limit",
    name: "Over-Limit Processing (Rare / Extreme Use)",
    price: "Internal enforcement only",
    purpose: "Soft limits are enforced internally. If exceeded, you’ll see a one-time upgrade offer.",
    includes: ["One-time upgrade offer", "Includes additional analysis credits", "No automatic overage charges"],
  },
];

const ORGS = {
  title: "Organizations & DV Shelters",
  price: "Custom pricing — Contact us",
  for: ["Domestic violence shelters", "Legal aid organizations", "Advocacy groups"],
  includes: ["Custom onboarding", "Privacy-first configurations", "Non-profit pricing", "Bulk access options"],
};

const REFUNDS = {
  headline: "Refund policy",
  body: "No refunds on monthly or yearly subscriptions.",
  exceptions: ["Duplicate charge", "Technical failure preventing access for an extended period", "Billing error"],
  footnote: "All exceptions require review.",
};

function money(n: number) {
  return n.toFixed(2);
}

function Toggle({
  billingMode,
  setBillingMode,
}: {
  billingMode: BillingMode;
  setBillingMode: (m: BillingMode) => void;
}) {
  return (
    <div className="inline-flex items-center rounded-2xl border border-neutral-900/30 bg-white/10 p-1">
      <button
        type="button"
        onClick={() => setBillingMode("monthly")}
        className={[
          "rounded-xl px-4 py-2 text-sm font-semibold transition",
          billingMode === "monthly"
            ? "bg-white text-neutral-900 shadow-sm"
            : "text-neutral-900/70 hover:text-neutral-900",
        ].join(" ")}
      >
        Monthly
      </button>

      <button
        type="button"
        onClick={() => setBillingMode("yearly")}
        className={[
          "ml-1 flex items-center gap-2 rounded-xl px-4 py-2 text-sm font-semibold transition",
          billingMode === "yearly"
            ? "bg-white text-neutral-900 shadow-sm"
            : "text-neutral-900/70 hover:text-neutral-900",
        ].join(" ")}
      >
        Yearly
        <span className="inline-flex items-center rounded-full border border-neutral-900/30 bg-white/40 px-2 py-[2px] text-[11px] font-semibold leading-none">
          Save {YEARLY_SAVINGS_PERCENT}%
        </span>
      </button>
    </div>
  );
}

function FeatureList({ title, items }: { title: string; items: string[] }) {
  return (
    <details className="mt-4 rounded-xl border border-neutral-900/15 bg-white/5 p-4">
      <summary className="cursor-pointer select-none text-sm font-semibold">{title}</summary>
      <ul className="mt-3 space-y-2 text-sm text-neutral-900/90">
        {items.map((it) => (
          <li key={it} className="flex gap-2">
            <span className="mt-[2px]">✓</span>
            <span className="leading-snug">{it}</span>
          </li>
        ))}
      </ul>
    </details>
  );
}

function AddOnMini({ addon }: { addon: AddOn }) {
  return (
    <div className="rounded-xl border border-neutral-900/20 bg-white/10 p-4">
      <div className="text-sm font-semibold">{addon.name}</div>
      <div className="mt-1 text-sm text-neutral-900/80">{addon.price}</div>
      <div className="mt-2 text-xs text-neutral-900/70">{addon.purpose}</div>
    </div>
  );
}

function AddOnCard({ addon }: { addon: AddOn }) {
  return (
    <div className="h-full rounded-2xl border border-neutral-900/30 bg-white/5 p-6">
      <div className="text-lg font-semibold">{addon.name}</div>
      <div className="mt-1 text-sm text-neutral-800/80">{addon.price}</div>
      <div className="mt-4 text-sm text-neutral-900/90">{addon.purpose}</div>
      <div className="my-5 h-px w-full bg-neutral-900/15" />
      <ul className="space-y-2 text-sm text-neutral-900/90">
        {addon.includes.map((it) => (
          <li key={it} className="flex gap-2">
            <span className="mt-[2px]">✓</span>
            <span className="leading-snug">{it}</span>
          </li>
        ))}
      </ul>
      {addon.footnote ? <p className="mt-4 text-xs text-neutral-800/70">{addon.footnote}</p> : null}
    </div>
  );
}

function PlanPrice({ plan, billingMode }: { plan: Plan; billingMode: BillingMode }) {
  if (plan.id === "starter") {
    return (
      <>
        <div className="flex items-end gap-2">
          <div className="text-5xl font-black">{plan.fixedPriceLabel}</div>
          <div className="pb-2 text-sm text-neutral-800/70">{plan.fixedPriceSub}</div>
        </div>
        <div className="mt-1 text-sm text-neutral-800/70">Then choose a plan.</div>
      </>
    );
  }
  const amount = billingMode === "yearly" ? plan.yearly! : plan.monthly!;
  return (
    <>
      <div className="flex items-end gap-2">
        <div className="text-5xl font-black">${money(amount)}</div>
        <div className="pb-2 text-sm text-neutral-800/70">{billingMode === "yearly" ? "/yr" : "/mo"}</div>
      </div>
      <div className="mt-1 text-sm text-neutral-800/70">Per user</div>
    </>
  );
}

export default function Plans() {
  const [billingMode, setBillingMode] = useState<BillingMode>("monthly");
  const plans = useMemo(() => PLANS, []);

  return (
    <main className="min-h-screen bg-[#d8e2df]">
      {/* HERO */}
      <section className="mx-auto w-full max-w-6xl px-4 pt-20 pb-14">
        <div className="grid grid-cols-1 gap-10 lg:grid-cols-2 lg:items-start">
          <div>
            <h1 className="text-6xl font-black leading-[0.95] text-neutral-900">Plans &amp; Pricing</h1>
            <p className="mt-5 max-w-xl text-base text-neutral-900/80">
              Family law only. Built for self-represented users across U.S. jurisdictions — educational and organizational
              tools, not legal advice.
            </p>

            <div className="mt-8 rounded-2xl border border-neutral-900/30 bg-white/10 p-6">
              <div className="text-sm font-semibold text-neutral-900">Shared principles (all plans)</div>
              <ul className="mt-3 space-y-2 text-sm text-neutral-900/90">
                {SHARED_PRINCIPLES.map((it) => (
                  <li key={it} className="flex gap-2">
                    <span className="mt-[2px]">✓</span>
                    <span className="leading-snug">{it}</span>
                  </li>
                ))}
              </ul>
            </div>
          </div>

          {/* ADD-ONS IN HERO (requested) */}
          <div>
            <div className="rounded-2xl border border-neutral-900/30 bg-white/10 p-6">
              <div className="text-sm font-semibold text-neutral-900">Add-ons (optional)</div>
              <p className="mt-2 text-sm text-neutral-900/80">
                Add extra capacity without changing your base plan.
              </p>

              <div className="mt-5 grid grid-cols-1 gap-4 sm:grid-cols-2">
                <AddOnMini addon={ADD_ONS[0]} />
                <AddOnMini addon={ADD_ONS[1]} />
              </div>

              <div className="mt-4 text-xs text-neutral-900/70">
                Over-limit processing is handled internally (no automatic overage charges).
              </div>
            </div>
          </div>
        </div>
      </section>

      {/* PLANS */}
      <section className="mx-auto w-full max-w-6xl px-4 pb-16">
        <div className="flex flex-col gap-4 sm:flex-row sm:items-end sm:justify-between">
          <div>
            <h2 className="text-4xl font-black text-neutral-900">Choose what fits</h2>
            <p className="mt-2 text-sm text-neutral-900/70">
              Individual plans are per user. Organizations and DV shelters are custom pricing.
            </p>
          </div>

          {/* Toggle affects Core/Pro/Premium pricing; Starter stays fixed */}
          <Toggle billingMode={billingMode} setBillingMode={setBillingMode} />
        </div>

        {/* 4 across on desktop */}
        <div className="mt-8 grid grid-cols-1 gap-6 sm:grid-cols-2 lg:grid-cols-4 items-stretch">
          {plans.map((plan) => (
            <div key={plan.id} className="h-full rounded-2xl border border-neutral-900/30 bg-white/5 p-6 flex flex-col">
              <div>
                <div className="text-lg font-semibold">{plan.name}</div>
                <p className="mt-1 text-sm text-neutral-900/75">{plan.purpose}</p>

                <div className="my-5 h-px w-full bg-neutral-900/15" />

                <PlanPrice plan={plan} billingMode={billingMode} />

                <div className="my-5 h-px w-full bg-neutral-900/15" />

                <div className="text-sm font-semibold text-neutral-900">Highlights</div>
                <ul className="mt-3 space-y-2 text-sm text-neutral-900/90">
                  {plan.included.slice(0, 6).map((it) => (
                    <li key={it} className="flex gap-2">
                      <span className="mt-[2px]">✓</span>
                      <span className="leading-snug">{it}</span>
                    </li>
                  ))}
                </ul>

                <FeatureList title="See everything included" items={plan.included} />
                {plan.notIncluded?.length ? <FeatureList title="Not included" items={plan.notIncluded} /> : null}
              </div>

              <div className="mt-auto pt-6">
                <button className="w-full rounded-full bg-[#0f3b2e] py-3 text-sm font-semibold text-white">
                  {plan.cta}
                </button>
                <p className="mt-3 text-xs text-neutral-900/70">{plan.finePrint}</p>
              </div>
            </div>
          ))}
        </div>
      </section>

      {/* ADD-ONS (FULL SECTION) */}
      <section className="mx-auto w-full max-w-6xl px-4 pb-16">
        <h3 className="text-3xl font-black text-neutral-900">Add-ons</h3>
        <p className="mt-2 text-sm text-neutral-900/70">
          Optional upgrades you can add without changing your base plan.
        </p>

        <div className="mt-6 grid grid-cols-1 gap-6 md:grid-cols-3 items-stretch">
          {ADD_ONS.map((a) => (
            <AddOnCard key={a.id} addon={a} />
          ))}
        </div>
      </section>

      {/* ORGS */}
      <section className="mx-auto w-full max-w-6xl px-4 pb-16">
        <div className="rounded-2xl border border-neutral-900/30 bg-white/10 p-8">
          <div className="text-2xl font-black text-neutral-900">{ORGS.title}</div>
          <div className="mt-1 text-sm text-neutral-900/75">{ORGS.price}</div>

          <div className="mt-6 grid grid-cols-1 gap-6 md:grid-cols-2">
            <div>
              <div className="text-sm font-semibold">For</div>
              <ul className="mt-3 space-y-2 text-sm text-neutral-900/90">
                {ORGS.for.map((it) => (
                  <li key={it} className="flex gap-2">
                    <span className="mt-[2px]">✓</span>
                    <span>{it}</span>
                  </li>
                ))}
              </ul>
            </div>

            <div>
              <div className="text-sm font-semibold">Includes</div>
              <ul className="mt-3 space-y-2 text-sm text-neutral-900/90">
                {ORGS.includes.map((it) => (
                  <li key={it} className="flex gap-2">
                    <span className="mt-[2px]">✓</span>
                    <span>{it}</span>
                  </li>
                ))}
              </ul>
            </div>
          </div>

          <div className="mt-8">
            <a
              href="/contact"
              className="inline-flex w-full items-center justify-center rounded-full bg-[#0f3b2e] py-3 text-sm font-semibold text-white"
            >
              Contact us
            </a>
            <p className="mt-3 text-xs text-neutral-900/70">
              We’ll help set up privacy-first configurations and onboarding for your team.
            </p>
          </div>
        </div>
      </section>

      {/* REFUND POLICY */}
      <section className="mx-auto w-full max-w-6xl px-4 pb-24">
        <div className="text-center text-sm text-neutral-900/70">
          <div className="font-semibold text-neutral-900">{REFUNDS.headline}</div>
          <div className="mt-2">{REFUNDS.body}</div>

          <div className="mt-3">Limited exceptions:</div>
          <div className="mt-2 flex flex-col items-center gap-1">
            {REFUNDS.exceptions.map((it) => (
              <div key={it}>• {it}</div>
            ))}
          </div>

          <div className="mt-3">{REFUNDS.footnote}</div>
        </div>
      </section>
    </main>
  );
}