# REPLIT TASK: Make authenticated audit + (optional) Playwright UI tests actually run, and produce a real report
# Notes:
# - You must already have a QA user created in the app (email+password you control).
# - Do NOT paste credentials into chat. Only store them in Replit Secrets.

set -e

echo "== 0) Verify required secrets exist =="
node -e "const req=['TEST_EMAIL','TEST_PASSWORD']; const missing=req.filter(k=>!process.env[k]); if(missing.length){ console.error('Missing Replit Secrets:', missing.join(', ')); process.exit(1);} console.log('Secrets present:', req.map(k=>k+'=YES').join(' '));"

echo "== 1) Quick sanity: print trimmed lengths only (avoid leaking secrets) =="
node - <<'NODE'
const e=(process.env.TEST_EMAIL||"");
const p=(process.env.TEST_PASSWORD||"");
console.log("TEST_EMAIL length:", e.length, "trimmed:", e.trim().length);
console.log("TEST_PASSWORD length:", p.length, "trimmed:", p.trim().length);
if(e !== e.trim() || p !== p.trim()){
  console.log("WARNING: Secrets have leading/trailing whitespace. We'll trim in scripts below if needed.");
}
NODE

echo "== 2) Ensure audit scripts TRIM secrets before use =="
# If your login helper reads TEST_EMAIL/TEST_PASSWORD directly, force trimming by patching a common helper location.
# Adjust the path if your repo uses a different helper file name.
# This patch is safe: it only changes env reads to .trim()
python - <<'PY'
import glob, re, os, sys
candidates = [
  "script/aiSmoke.ts",
  "script/apiSmoke.ts",
  "tests/helpers/auth.ts",
  "tests/utils/auth.ts",
  "script/helpers/auth.ts",
]
found=[]
for path in candidates:
  if os.path.exists(path):
    found.append(path)

if not found:
  print("No known auth helper files found. Skipping patch. (If auth still fails, search for TEST_EMAIL usage.)")
  sys.exit(0)

for path in found:
  txt=open(path,"r",encoding="utf-8").read()
  orig=txt
  # Trim TEST_EMAIL/TEST_PASSWORD when read
  txt=re.sub(r'process\.env\.TEST_EMAIL(\s*\|\|\s*["\']{2})?', r'(process.env.TEST_EMAIL||"").trim()', txt)
  txt=re.sub(r'process\.env\.TEST_PASSWORD(\s*\|\|\s*["\']{2})?', r'(process.env.TEST_PASSWORD||"").trim()', txt)
  if txt!=orig:
    open(path,"w",encoding="utf-8").write(txt)
    print("Patched trimming in:", path)
  else:
    print("No changes needed in:", path)
PY

echo "== 3) Run route inventories =="
npx tsx script/auditBackendRoutes.ts
npx tsx script/auditFrontendRoutes.ts

echo "== 4) Run unauthenticated API smoke =="
npx tsx script/apiSmoke.ts

echo "== 5) Run authenticated AI/API smoke (requires TEST_EMAIL/TEST_PASSWORD) =="
npx tsx script/aiSmoke.ts

echo "== 6) Generate full audit report =="
npx tsx script/generateFullAudit.ts

echo "== 7) OPTIONAL: Try Playwright UI tests =="
echo "Installing Playwright + browsers (if not already installed)..."
npm i -D @playwright/test >/dev/null 2>&1 || true
npx playwright install || true

echo "Attempting to install Linux deps (may or may not be allowed in your Replit image)..."
npx playwright install-deps || true

echo "Running Playwright tests (if deps are satisfied). If this fails due to system libs, that's OK â€” API audits still stand."
npx playwright test || true

echo ""
echo "== DONE =="
echo "Outputs to look for:"
echo "- audit/backend_routes.json"
echo "- audit/frontend_routes.json"
echo "- AUDIT_REPORT_FULL_APP.md"
echo "- Playwright console output (if it ran)"