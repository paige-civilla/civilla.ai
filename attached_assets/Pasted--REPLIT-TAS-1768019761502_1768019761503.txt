/****************************************************************************************
REPLIT TASK: Grant Dashboard v2 (Charts + CSV Export + Print-to-PDF Impact Summary)

Assumptions (based on your v1 summary):
- /api/grants/metrics exists and returns privacy-safe aggregates
- requireGrantViewer middleware exists
- AppGrantDashboard.tsx exists at /app/grants
- user_profiles has is_grant_viewer already

Goal:
1) Expand /api/grants/metrics to also return time-series arrays (newUsersByDay, newCasesByDay, activeUsersByDay)
2) Add /api/grants/metrics.csv endpoint (download CSV)
3) Add /app/grants/print page that renders a clean "Impact Summary" and supports Print -> Save as PDF
4) Add charts to AppGrantDashboard.tsx using recharts
****************************************************************************************/

/* =========================
   A) Backend: expand grant metrics to include time series
   ========================= */

// FILE: server/services/grantMetrics.ts
// Add helpers + time series into the existing return object.
// If table/column names differ in your codebase, adjust ONLY those names.

type LabelCount = { label: string; count: number };

function bucketSmallCounts(rows: LabelCount[], threshold = 5): LabelCount[] {
  let other = 0;
  const kept: LabelCount[] = [];
  for (const r of rows) {
    if ((r.count ?? 0) < threshold) other += r.count ?? 0;
    else kept.push(r);
  }
  if (other > 0) kept.push({ label: `Other / <${threshold}`, count: other });
  return kept;
}

export async function getGrantMetrics(params: { days?: number }) {
  const days = Math.max(7, Math.min(365, params.days ?? 90));
  // NOTE: if you're using drizzle/sql tagged strings, keep your existing style.
  // This is plain SQL for clarity. Adapt to your db helper if needed.
  const sinceSql = `NOW() - INTERVAL '${days} days'`;

  const totalUsers = await db.query(`SELECT COUNT(*)::int AS count FROM users`);
  const totalCases = await db.query(`SELECT COUNT(*)::int AS count FROM cases`);
  const activeUsers = await db.query(`
    SELECT COUNT(DISTINCT user_id)::int AS count
    FROM activity_logs
    WHERE created_at >= ${sinceSql}
  `);

  const casesByStateRaw = await db.query(`
    SELECT COALESCE(state, 'Unknown') AS label, COUNT(*)::int AS count
    FROM cases
    GROUP BY COALESCE(state, 'Unknown')
    ORDER BY count DESC
    LIMIT 25
  `);

  const moduleUsageRaw = await db.query(`
    SELECT COALESCE(metadata->>'moduleKey','unknown') AS label, COUNT(*)::int AS count
    FROM activity_logs
    WHERE created_at >= ${sinceSql}
      AND event_type IN ('module_view','search_click','doc_export','pattern_export','trial_binder_export')
    GROUP BY COALESCE(metadata->>'moduleKey','unknown')
    ORDER BY count DESC
    LIMIT 15
  `);

  const aiFailuresRaw = await db.query(`
    SELECT event_type AS label, COUNT(*)::int AS count
    FROM activity_logs
    WHERE created_at >= ${sinceSql}
      AND event_type IN ('evidence_extraction_failed','claims_suggest_failed','ai_analysis_failed','lexi_error')
    GROUP BY event_type
    ORDER BY count DESC
  `);

  // Time-series (daily)
  const newUsersByDay = await db.query(`
    SELECT to_char(date_trunc('day', created_at), 'YYYY-MM-DD') AS day,
           COUNT(*)::int AS count
    FROM users
    WHERE created_at >= ${sinceSql}
    GROUP BY 1
    ORDER BY 1
  `);

  const newCasesByDay = await db.query(`
    SELECT to_char(date_trunc('day', created_at), 'YYYY-MM-DD') AS day,
           COUNT(*)::int AS count
    FROM cases
    WHERE created_at >= ${sinceSql}
    GROUP BY 1
    ORDER BY 1
  `);

  const activeUsersByDay = await db.query(`
    SELECT to_char(date_trunc('day', created_at), 'YYYY-MM-DD') AS day,
           COUNT(DISTINCT user_id)::int AS count
    FROM activity_logs
    WHERE created_at >= ${sinceSql}
    GROUP BY 1
    ORDER BY 1
  `);

  return {
    ok: true,
    windowDays: days,
    totals: {
      users: totalUsers.rows?.[0]?.count ?? 0,
      cases: totalCases.rows?.[0]?.count ?? 0,
      activeUsers: activeUsers.rows?.[0]?.count ?? 0,
    },
    distributions: {
      casesByState: bucketSmallCounts((casesByStateRaw.rows ?? []) as any[], 5),
      moduleUsage: bucketSmallCounts((moduleUsageRaw.rows ?? []) as any[], 5),
      aiFailures: bucketSmallCounts((aiFailuresRaw.rows ?? []) as any[], 5),
    },
    timeSeries: {
      newUsersByDay: (newUsersByDay.rows ?? []).map((r: any) => ({ day: r.day, count: r.count })),
      newCasesByDay: (newCasesByDay.rows ?? []).map((r: any) => ({ day: r.day, count: r.count })),
      activeUsersByDay: (activeUsersByDay.rows ?? []).map((r: any) => ({ day: r.day, count: r.count })),
    },
    privacy: {
      notes: [
        "Aggregated metrics only (no user-uploaded content).",
        "Small counts are bucketed to reduce re-identification risk.",
        "No names, emails, messages, evidence text, or document text are accessible.",
      ],
    },
  };
}


/* =========================
   B) Backend: add CSV export endpoint
   ========================= */

// FILE: server/routes.ts
// Add below /api/grants/metrics route (keep same middleware)

function asCsvRow(cols: (string | number | null | undefined)[]) {
  return cols
    .map((c) => {
      const s = c === null || c === undefined ? "" : String(c);
      const escaped = s.replace(/"/g, '""');
      return `"${escaped}"`;
    })
    .join(",");
}

app.get("/api/grants/metrics.csv", requireAuth, requireGrantViewer, async (req, res) => {
  try {
    const days = req.query.days ? Number(req.query.days) : 90;
    const data = await getGrantMetrics({ days });

    const lines: string[] = [];
    lines.push(asCsvRow(["Metric Window (days)", data.windowDays]));
    lines.push("");

    lines.push(asCsvRow(["Totals"]));
    lines.push(asCsvRow(["Total Users", data.totals.users]));
    lines.push(asCsvRow(["Total Cases", data.totals.cases]));
    lines.push(asCsvRow(["Active Users (window)", data.totals.activeUsers]));
    lines.push("");

    lines.push(asCsvRow(["Cases by State"]));
    lines.push(asCsvRow(["State", "Count"]));
    for (const r of data.distributions.casesByState ?? []) lines.push(asCsvRow([r.label, r.count]));
    lines.push("");

    lines.push(asCsvRow(["Module Usage"]));
    lines.push(asCsvRow(["Module", "Count"]));
    for (const r of data.distributions.moduleUsage ?? []) lines.push(asCsvRow([r.label, r.count]));
    lines.push("");

    lines.push(asCsvRow(["AI Failures"]));
    lines.push(asCsvRow(["Type", "Count"]));
    for (const r of data.distributions.aiFailures ?? []) lines.push(asCsvRow([r.label, r.count]));
    lines.push("");

    lines.push(asCsvRow(["Time Series - Active Users / Day"]));
    lines.push(asCsvRow(["Day", "Count"]));
    for (const r of data.timeSeries.activeUsersByDay ?? []) lines.push(asCsvRow([r.day, r.count]));
    lines.push("");

    lines.push(asCsvRow(["Time Series - New Users / Day"]));
    lines.push(asCsvRow(["Day", "Count"]));
    for (const r of data.timeSeries.newUsersByDay ?? []) lines.push(asCsvRow([r.day, r.count]));
    lines.push("");

    lines.push(asCsvRow(["Time Series - New Cases / Day"]));
    lines.push(asCsvRow(["Day", "Count"]));
    for (const r of data.timeSeries.newCasesByDay ?? []) lines.push(asCsvRow([r.day, r.count]));

    const csv = lines.join("\n");
    res.setHeader("Content-Type", "text/csv; charset=utf-8");
    res.setHeader("Content-Disposition", `attachment; filename="civilla_grant_metrics_${days}d.csv"`);
    res.send(csv);
  } catch (e) {
    console.error("[GrantsCSV] failed", e);
    res.status(500).json({ ok: false, error: "Failed to export CSV" });
  }
});


/* =========================
   C) Frontend: Print-to-PDF Impact Summary page
   ========================= */

// FILE: client/src/pages/AppGrantDashboardPrint.tsx (NEW)
import { useEffect } from "react";
import { useQuery } from "@tanstack/react-query";

export default function AppGrantDashboardPrint() {
  const params = new URLSearchParams(window.location.search);
  const days = Number(params.get("days") ?? "90");

  const { data, isLoading } = useQuery({
    queryKey: ["/api/grants/metrics", { days }],
    queryFn: async () => {
      const res = await fetch(`/api/grants/metrics?days=${days}`, { credentials: "include" });
      if (!res.ok) throw new Error("Failed to load");
      return res.json();
    },
  });

  useEffect(() => {
    if (data?.ok) setTimeout(() => window.print(), 450);
  }, [data]);

  if (isLoading) return <div className="p-6">Loading report…</div>;
  if (!data?.ok) return <div className="p-6">Could not load report.</div>;

  return (
    <div className="p-8 max-w-4xl mx-auto">
      <style>{`
        @media print {
          button { display:none !important; }
          a { color: black; text-decoration: none; }
        }
      `}</style>

      <div className="flex items-start justify-between gap-4">
        <div>
          <h1 className="text-2xl font-bold">Civilla — Grant Impact Summary</h1>
          <div className="text-sm text-neutral-darkest/70 mt-1">
            Reporting Window: Last {data.windowDays} days
          </div>
          <div className="text-xs text-neutral-darkest/60 mt-2">
            Privacy: Aggregated metrics only. No user content is viewable.
          </div>
        </div>

        <button
          className="px-4 py-2 rounded border border-neutral-300 bg-white"
          onClick={() => window.print()}
        >
          Print / Save as PDF
        </button>
      </div>

      <hr className="my-6" />

      <h2 className="text-lg font-semibold">Totals</h2>
      <ul className="mt-2 text-sm space-y-1">
        <li>Total users: <strong>{data.totals.users}</strong></li>
        <li>Total cases: <strong>{data.totals.cases}</strong></li>
        <li>Active users (window): <strong>{data.totals.activeUsers}</strong></li>
      </ul>

      <hr className="my-6" />

      <h2 className="text-lg font-semibold">Cases by State</h2>
      <div className="mt-2 text-sm space-y-1">
        {(data.distributions.casesByState ?? []).map((r: any, idx: number) => (
          <div key={idx} className="flex justify-between">
            <span>{r.label}</span>
            <span className="font-semibold">{r.count}</span>
          </div>
        ))}
      </div>

      <hr className="my-6" />

      <h2 className="text-lg font-semibold">Module Usage</h2>
      <div className="mt-2 text-sm space-y-1">
        {(data.distributions.moduleUsage ?? []).map((r: any, idx: number) => (
          <div key={idx} className="flex justify-between">
            <span>{r.label}</span>
            <span className="font-semibold">{r.count}</span>
          </div>
        ))}
      </div>

      <hr className="my-6" />

      <h2 className="text-lg font-semibold">AI Reliability (Failures)</h2>
      <div className="mt-2 text-sm space-y-1">
        {(data.distributions.aiFailures ?? []).map((r: any, idx: number) => (
          <div key={idx} className="flex justify-between">
            <span>{r.label}</span>
            <span className="font-semibold">{r.count}</span>
          </div>
        ))}
      </div>

      <hr className="my-6" />

      <h2 className="text-lg font-semibold">Privacy Safeguards</h2>
      <ul className="mt-2 text-sm list-disc pl-5 space-y-1">
        {(data.privacy?.notes ?? []).map((n: string, i: number) => <li key={i}>{n}</li>)}
      </ul>
    </div>
  );
}


/* =========================
   D) Frontend: Add charts + export buttons to Grant Dashboard
   ========================= */

// FILE: client/src/pages/AppGrantDashboard.tsx
// Add recharts imports:
import {
  ResponsiveContainer,
  BarChart, Bar,
  LineChart, Line,
  XAxis, YAxis, Tooltip,
  CartesianGrid
} from "recharts";

// Add a window selector (7/30/90/180) and export buttons in your header area.
// Then add chart cards using: data.distributions.casesByState, data.distributions.moduleUsage, data.timeSeries.activeUsersByDay

/*
Example additions:

1) Header actions:

const [days, setDays] = useState(90);

<div className="flex flex-wrap items-center gap-2 mt-3">
  <select
    className="border rounded px-2 py-2 text-sm bg-white"
    value={days}
    onChange={(e) => setDays(Number(e.target.value))}
  >
    <option value={7}>Last 7 days</option>
    <option value={30}>Last 30 days</option>
    <option value={90}>Last 90 days</option>
    <option value={180}>Last 180 days</option>
  </select>

  <a
    className="px-3 py-2 rounded border border-[hsl(var(--module-tile-border))] bg-white text-sm"
    href={`/api/grants/metrics.csv?days=${days}`}
    target="_blank"
    rel="noreferrer"
  >
    Download CSV
  </a>

  <a
    className="px-3 py-2 rounded border border-[hsl(var(--module-tile-border))] bg-white text-sm"
    href={`/app/grants/print?days=${days}`}
    target="_blank"
    rel="noreferrer"
  >
    Impact Summary (Save as PDF)
  </a>
</div>

2) Charts:

<div className="grid gap-4 md:grid-cols-3 mt-4">
  <div className="md:col-span-3 bg-white rounded-lg border border-[hsl(var(--module-tile-border))] p-5">
    <h2 className="font-bold mb-3">Active Users Over Time</h2>
    <div className="h-72">
      <ResponsiveContainer width="100%" height="100%">
        <LineChart data={data.timeSeries.activeUsersByDay ?? []}>
          <CartesianGrid strokeDasharray="3 3" />
          <XAxis dataKey="day" hide />
          <YAxis allowDecimals={false} />
          <Tooltip />
          <Line type="monotone" dataKey="count" dot={false} />
        </LineChart>
      </ResponsiveContainer>
    </div>
  </div>

  <div className="md:col-span-2 bg-white rounded-lg border border-[hsl(var(--module-tile-border))] p-5">
    <h2 className="font-bold mb-3">Cases by State (Top)</h2>
    <div className="h-72">
      <ResponsiveContainer width="100%" height="100%">
        <BarChart data={(data.distributions.casesByState ?? []).slice(0, 12)}>
          <CartesianGrid strokeDasharray="3 3" />
          <XAxis dataKey="label" interval={0} angle={-25} textAnchor="end" height={70} />
          <YAxis allowDecimals={false} />
          <Tooltip />
          <Bar dataKey="count" />
        </BarChart>
      </ResponsiveContainer>
    </div>
  </div>

  <div className="bg-white rounded-lg border border-[hsl(var(--module-tile-border))] p-5">
    <h2 className="font-bold mb-3">Module Usage (Top)</h2>
    <div className="h-72">
      <ResponsiveContainer width="100%" height="100%">
        <BarChart data={(data.distributions.moduleUsage ?? []).slice(0, 10)}>
          <CartesianGrid strokeDasharray="3 3" />
          <XAxis dataKey="label" interval={0} angle={-25} textAnchor="end" height={70} />
          <YAxis allowDecimals={false} />
          <Tooltip />
          <Bar dataKey="count" />
        </BarChart>
      </ResponsiveContainer>
    </div>
  </div>
</div>
*/


/* =========================
   E) Routing: add print route
   ========================= */

// FILE: client/src/App.tsx
// Import and add route:
import AppGrantDashboardPrint from "@/pages/AppGrantDashboardPrint";

// Add:
<Route path="/app/grants/print" component={AppGrantDashboardPrint} />