/**
 * REPLIT — DO THIS:
 * 1) Open: client/src/pages/Plans.tsx
 * 2) Replace the entire file with this content
 * 3) Save + run
 *
 * Notes:
 * - Individual plans are PER USER (single-user). Org pricing is separate + "Contact us".
 * - Monthly/Yearly toggle applies ONLY to paid individual plans (Core/Pro/Premium).
 * - Free Starter is always $0 for 3 days (toggle does not change it).
 * - Add-ons are shown in the HERO area (as requested).
 * - "Save ~17%" is replaced with a clean badge: "Save 17%".
 */

import React, { useMemo, useState } from "react";

type BillingMode = "monthly" | "yearly";

type IndividualPlan = {
  id: "trial" | "core" | "pro" | "premium";
  name: string;
  tagline: string;
  monthly?: number; // undefined for trial
  yearly?: number;  // undefined for trial
  priceLabelOverride?: string; // for trial
  cta: string;
  includedHighlights: string[];
  notIncludedHighlights?: string[];
  finePrint: string;
};

type AddOn = {
  id: string;
  name: string;
  price: string;
  purpose: string;
  includes: string[];
  footnote?: string;
};

const YEARLY_SAVINGS_PERCENT = 17;

const SHARED_PRINCIPLES: string[] = [
  "Educational and organizational only — not legal advice",
  "Not a law firm; does not represent you or replace an attorney",
  "Document tools require affirmative acknowledgment before download",
  "No refunds on subscriptions (narrow exceptions listed below)",
  "Supports interstate U.S. family-law cases (state selected during onboarding)",
  "Built for self-represented (pro se) users",
];

const INDIVIDUAL_PLANS: IndividualPlan[] = [
  {
    id: "trial",
    name: "civilla free starter",
    tagline: "See how civilla works — without heavy processing or downloads.",
    priceLabelOverride: "$0",
    cta: "start free starter",
    includedHighlights: [
      "1 family-law case (view-only)",
      "Pattern analysis (read-only)",
      "Evidence upload (documents only)",
      "Evidence timeline (read-only)",
      "Case Journey overview (read-only)",
      "Lexi research & education (text + talk-to-text)",
      "Plain-language explanations of common family-law terms",
      "Create 1 sample document (cannot download; permanent watermark)",
      "Kid profiles (basic)",
      "Journaling / notes (not analyzed)",
      "Dark mode & accessibility settings",
    ],
    notIncludedHighlights: [
      "No document downloads",
      "No exhibits builder",
      "No transcription",
      "No video/audio uploads",
      "No AI deadline extraction or reminders",
      "No service documents (certificates / notices)",
      "No parenting plan builder",
      "No child support estimator",
      "No additional storage purchases",
      "No co-parent communication tools (CivillaConnect)",
    ],
    finePrint:
      "Free Starter is $0 for 3 days. Educational use only. Not legal advice.",
  },
  {
    id: "core",
    name: "civilla core",
    tagline: "For one user actively organizing one family-law case.",
    monthly: 19.99,
    yearly: 199,
    cta: "start core",
    includedHighlights: [
      "Everything in Free Starter, plus:",
      "1 active family-law case (per user)",
      "30 GB storage",
      "Unlimited document uploads (reasonable use enforced)",
      "Evidence timeline (fully interactive)",
      "Pattern analysis (full)",
      "Lexi research engine (statutes, case law, court rules) with citations",
      "AI document analysis",
      "AI deadline extraction (requires user confirmation)",
      "Task & deadline tracking",
      "Reminders (email or text — opt-in, confirm before activation)",
      "Document creator (responses, counter-petitions, motions, etc.)",
      "Downloadable docs with mandatory disclaimers + civilla educational footnotes",
      "Notices/certificates of service",
      "Parenting plan builder",
      "Child support estimator (education only)",
      "Exhibit builder (basic)",
      "Audio uploads + transcription",
      "Large document accommodation (e.g., OFW exports)",
      "Kid profiles with evidence linking",
    ],
    notIncludedHighlights: [
      "Co-parent communication (CivillaConnect)",
      "Advanced exhibits",
      "Video uploads",
    ],
    finePrint:
      "Per user. Educational and organizational only. Not legal advice.",
  },
  {
    id: "pro",
    name: "civilla pro",
    tagline: "Advanced organization, exhibits, and deeper workflows.",
    monthly: 29.99,
    yearly: 299,
    cta: "start pro",
    includedHighlights: [
      "Everything in Core, plus:",
      "50 GB storage",
      "Advanced exhibits builder",
      "Video uploads",
      "Dual OCR verification (cross-checked)",
      "Advanced pattern reporting (timeline → evidence → claim mapping)",
      "Narrative building support (educational organization)",
      "Parenting plan “age-up” scenarios",
      "High-conflict case support tools",
      "Mediation & pre-trial preparation workflows",
      "Hearing & trial prep organization",
      "Draft trial binder structure",
      "Evidence tagging by issue, child, and claim",
      "Enhanced Lexi research depth",
      "Priority processing",
    ],
    finePrint:
      "Per user. Educational and organizational only. Not legal advice.",
  },
  {
    id: "premium",
    name: "civilla premium",
    tagline: "For complex cases needing the most structure and support.",
    monthly: 49.99,
    yearly: 499,
    cta: "start premium",
    includedHighlights: [
      "Everything in Pro, plus:",
      "100 GB storage",
      "Advanced narrative reports (court-ready organization, still educational)",
      "Full exhibits management",
      "Multi-child, multi-issue analytics",
      "Advanced reminders & escalation tracking",
      "Complex discovery tracking",
      "Post-judgment workflows (enforcement, modification)",
      "Appeals awareness (education only)",
      "Priority support",
      "Early access to new features",
    ],
    finePrint:
      "Per user. Educational and organizational only. Not legal advice.",
  },
];

const ADD_ONS: AddOn[] = [
  {
    id: "case-slot",
    name: "Additional Case Slot",
    price: "$9.99/month per additional case",
    purpose:
      "For people managing multiple co-parents or multiple family-law cases.",
    includes: [
      "+1 additional case slot",
      "+30 GB storage per case",
      "Full feature parity with your current plan",
    ],
  },
  {
    id: "evidence-only",
    name: "Evidence-Only Storage (No Analysis)",
    price: "$4.99/month",
    purpose:
      "Upload and organize evidence without triggering analysis or heavy processing.",
    includes: [
      "Evidence uploads",
      "Journaling / notes",
      "Timeline storage",
      "No analysis until upgraded",
      "When upgraded, backlog analysis is included (no retroactive penalty)",
    ],
  },
  {
    id: "over-limit",
    name: "Over-Limit Processing (Rare / Extreme Use)",
    price: "No automatic overages",
    purpose:
      "Soft limits are enforced internally. If exceeded, you’ll see a one-time upgrade offer.",
    includes: [
      "One-time upgrade offer if limits are exceeded",
      "Includes additional analysis credits",
      "No automatic overage charges",
    ],
    footnote:
      "Designed to protect privacy, prevent misuse, and control compute costs.",
  },
];

const ORG_SECTION = {
  title: "Organizations & DV Shelters",
  price: "Custom pricing — Contact us",
  whoFor: [
    "Domestic violence shelters",
    "Legal aid organizations",
    "Advocacy groups",
  ],
  includes: [
    "Custom onboarding",
    "Privacy-first configurations",
    "Nonprofit pricing",
    "Bulk access options",
  ],
};

const REFUND_POLICY = {
  headline: "Refund policy",
  body: "No refunds on monthly or yearly subscriptions.",
  exceptions: [
    "Duplicate charge",
    "Technical failure preventing access for an extended period",
    "Billing error",
  ],
  footnote: "All exceptions require review.",
};

function formatMoney(n: number) {
  return n.toFixed(2);
}

function PlanPrice({
  plan,
  billingMode,
}: {
  plan: IndividualPlan;
  billingMode: BillingMode;
}) {
  // Trial is always $0 for 3 days
  if (plan.id === "trial") {
    return (
      <>
        <div className="flex items-end gap-2">
          <div className="text-5xl font-bold">{plan.priceLabelOverride}</div>
          <div className="pb-2 text-sm text-neutral-800/70">for 3 days</div>
        </div>
        <div className="mt-1 text-sm text-neutral-800/70">Then choose a plan.</div>
      </>
    );
  }

  const amount = billingMode === "yearly" ? plan.yearly! : plan.monthly!;
  return (
    <>
      <div className="flex items-end gap-2">
        <div className="text-5xl font-bold">${formatMoney(amount)}</div>
        <div className="pb-2 text-sm text-neutral-800/70">
          {billingMode === "yearly" ? "/yr" : "/mo"}
        </div>
      </div>
      <div className="mt-1 text-sm text-neutral-800/70">Per user</div>
    </>
  );
}

function Toggle({
  billingMode,
  setBillingMode,
}: {
  billingMode: BillingMode;
  setBillingMode: (m: BillingMode) => void;
}) {
  return (
    <div className="inline-flex items-center rounded-2xl border border-neutral-900/30 bg-white/10 p-1">
      <button
        type="button"
        onClick={() => setBillingMode("monthly")}
        className={[
          "rounded-xl px-4 py-2 text-sm font-semibold transition",
          billingMode === "monthly"
            ? "bg-white text-neutral-900 shadow-sm"
            : "text-neutral-900/70 hover:text-neutral-900",
        ].join(" ")}
      >
        Monthly
      </button>

      <button
        type="button"
        onClick={() => setBillingMode("yearly")}
        className={[
          "ml-1 flex items-center gap-2 rounded-xl px-4 py-2 text-sm font-semibold transition",
          billingMode === "yearly"
            ? "bg-white text-neutral-900 shadow-sm"
            : "text-neutral-900/70 hover:text-neutral-900",
        ].join(" ")}
      >
        Yearly
        <span className="inline-flex items-center rounded-full border border-neutral-900/30 bg-white/40 px-2 py-[2px] text-[11px] font-semibold leading-none">
          Save {YEARLY_SAVINGS_PERCENT}%
        </span>
      </button>
    </div>
  );
}

function FeatureList({
  title,
  items,
}: {
  title: string;
  items: string[];
}) {
  return (
    <details className="mt-4 rounded-xl border border-neutral-900/15 bg-white/5 p-4">
      <summary className="cursor-pointer select-none text-sm font-semibold">
        {title}
      </summary>
      <ul className="mt-3 space-y-2 text-sm text-neutral-900/90">
        {items.map((it) => (
          <li key={it} className="flex gap-2">
            <span className="mt-[2px]">✓</span>
            <span className="leading-snug">{it}</